openapi: 3.0.0
info:
  title: Chesstory API
  description: Backend API for PGN analysis, game review, and opening exploration.
  version: 1.0.0
servers:
  - url: http://localhost:8080
    description: Local Development Server

paths:
  # --- Core Analysis ---
  /api/game-review/chapter:
    post:
      summary: Submit a game for Chapter-based Review
      description: Queues a PGN for deep analysis, generating a narrative "book" structure.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                pgn:
                  type: string
                  description: The raw PGN text of the game.
                options:
                  type: object
                  properties:
                    depthProfile:
                      type: string
                      enum: [Fast, Deep, Tournament]
                      default: Fast
                    forceCriticalPlys:
                      type: array
                      items:
                        type: integer
      responses:
        '202':
          description: Job Accepted
          content:
            application/json:
              schema:
                type: object
                properties:
                  jobId:
                    type: string
                  status:
                    type: string
                    example: queued
    get:
      summary: Get Review Status or Result
      description: Polls the status of a job. Returns the full JSON result when ready.
      parameters:
        - name: jobId
          in: query
          description: (Legacy param style) - Prefer RESTful path if available, but currently implemented via path splitting in handler.
          schema:
            type: string
      responses:
        '200':
          description: Job Ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnalysisResult'
        '202':
          description: Processing
          content:
            application/json:
              schema:
                 type: object
                 properties:
                   jobId: 
                     type: string
                   status:
                     type: string
                   stage:
                     type: string
                   stageProgress:
                     type: number

  /api/game-review/chapter/{jobId}:
    get:
      summary: Get Review Result (RESTful)
      parameters:
        - name: jobId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Job Ready
          content:
            application/json:
              schema:
                 $ref: '#/components/schemas/AnalysisResult'

  # --- Interactive Features ---
  /analysis/branch:
    post:
      summary: Add Variation Branch
      description: Adds a user or engine variation to an existing analysis tree.
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                jobId:
                  type: string
                ply:
                  type: integer
                uci:
                  type: string
      responses:
        '200':
          description: Updated JSON
          
  /opening/lookup:
    get:
      summary: Opening Explorer
      parameters:
        - name: sans
          in: query
          required: true
          description: Space-separated SAN moves (e.g. "e4 e5 Nf3")
      responses:
        '200':
          description: Stats
          content:
            application/json:
              schema:
                type: object
                properties:
                  games:
                    type: integer
                  winWhite:
                    type: number
                  topMoves:
                    type: array
                    
  # --- Legacy / Utilities ---
  /status:
    get:
      summary: System Status (Localhost Only)
      responses:
        '200':
          description: Metrics
          content:
            application/json:
              schema:
                type: object
                properties:
                  activeJobs:
                    type: integer
                  cacheSize:
                    type: integer

components:
  schemas:
    AnalysisResult:
      type: object
      properties:
        jobId:
          type: string
        status:
          type: string
        schemaVersion:
          type: integer
          example: 4
        result:
          $ref: '#/components/schemas/AnalysisOutput'
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string

    AnalysisOutput:
      type: object
      properties:
        book:
          $ref: '#/components/schemas/Book'
        chapter:
          $ref: '#/components/schemas/GameChapter'
        timeline:
          type: array
          items:
            type: object
        summaryText:
          type: string

    # --- New Checklist-Aligned Format (Phase 1) ---
    GameChapter:
      type: object
      properties:
        chapterId:
          type: string
        meta:
          $ref: '#/components/schemas/GameMeta'
        sections:
          type: array
          items:
            $ref: '#/components/schemas/ChapterSection'

    GameMeta:
      type: object
      properties:
        white:
          type: string
        black:
          type: string
        result:
          type: string
          example: "1-0"
        openingName:
          type: string
        createdAt:
          type: string
          format: date-time

    ChapterSection:
      type: object
      properties:
        type:
          $ref: '#/components/schemas/SectionType'
        data:
          oneOf:
            - $ref: '#/components/schemas/TitleSummaryData'
            - $ref: '#/components/schemas/KeyDiagramsData'
            - $ref: '#/components/schemas/OpeningReviewData'
            - $ref: '#/components/schemas/TurningPointsData'
            - $ref: '#/components/schemas/TacticalMomentsData'
            - $ref: '#/components/schemas/MiddlegamePlansData'
            - $ref: '#/components/schemas/EndgameLessonsData'
            - $ref: '#/components/schemas/FinalChecklistData'

    TitleSummaryData:
      type: object
      properties:
        title:
          type: string
        summary:
          type: string

    KeyDiagramsData:
      type: object
      properties:
        diagrams:
          type: array
          items:
            $ref: '#/components/schemas/KeyDiagram'

    KeyDiagram:
      type: object
      properties:
        fen:
          type: string
        role:
          type: string
          enum: [opening, turning_point, tactical, endgame]
        tags:
          type: array
          items:
            type: string
        referenceMoves:
          type: array
          items:
            type: string

    OpeningReviewData:
      type: object
      properties:
        structure:
          type: string
        mainPlans:
          type: array
          items:
            type: string
        deviation:
          type: string

    TurningPointsData:
      type: object
      properties:
        points:
          type: array
          items:
            $ref: '#/components/schemas/TurningPoint'

    TurningPoint:
      type: object
      properties:
        ply:
          type: integer
        side:
          type: string
        playedMove:
          type: string
        bestMove:
          type: string
        evalBefore:
          type: integer
        evalAfterPlayed:
          type: integer
        evalAfterBest:
          type: integer

    TacticalMomentsData:
      type: object
      properties:
        moments:
          type: array
          items:
            type: object

    MiddlegamePlansData:
      type: object
      properties:
        dominantStructure:
          type: string
        plans:
          type: array
          items:
            $ref: '#/components/schemas/PlanSummary'

    PlanSummary:
      type: object
      properties:
        planType:
          type: string
        quality:
          type: string
          enum: [good, neutral, bad]
        description:
          type: string

    EndgameLessonsData:
      type: object
      properties:
        principles:
          type: array
          items:
            type: string

    FinalChecklistData:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/ChecklistItem'

    ChecklistItem:
      type: object
      properties:
        id:
          type: string
        category:
          type: string
          enum: [structure, plans, tactics, endgame]
        text:
          type: string
        tags:
          type: array
          items:
            type: string

    # --- Legacy Format (Backward Compatibility) ---
    Book:
      type: object
      properties:
        gameMeta:
          type: object
        sections:
          type: array
          items:
            $ref: '#/components/schemas/BookSection'
        turningPoints:
          type: array
          items:
            type: object
        checklist:
          type: array
          items:
            type: object

    BookSection:
      type: object
      properties:
        title:
          type: string
        sectionType:
          $ref: '#/components/schemas/SectionType'
        narrativeHint:
          type: string
        startPly:
          type: integer
        endPly:
          type: integer
        diagrams:
          type: array
          items:
            type: object

    SectionType:
      type: string
      enum:
        # Legacy types
        - opening_portrait
        - critical_crisis
        - structural_deep_dive
        - tactical_storm
        - endgame_masterclass
        - narrative_bridge
        # New checklist-aligned types (Phase 1)
        - title_summary
        - key_diagrams
        - opening_review
        - turning_points
        - tactical_moments
        - middlegame_plans
        - endgame_lessons
        - final_checklist
