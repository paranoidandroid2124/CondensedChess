$analyse-block-gap: $block-gap;

body {
  /* prevents scroll bar flicker on page height changes */
  overflow-y: scroll;
}

#main-wrap {
  ---main-max-width: calc(100vh - #{$site-header-outer-height} - #{$col1-uniboard-controls});

  @include mq-at-least-col2 {
    ---main-max-width: auto;
  }
}

.analyse {
  grid-area: main;
  display: grid;

  &__side {
    grid-area: side;
    justify-content: start;
  }

  &__board {
    grid-area: board;

    cg-container {
      @include inline-end(0);
    }
  }

  // Wrapper: horizontal eval gauge + board stacked vertically
  &__board-wrap {
    grid-area: board;
    display: flex;
    flex-direction: column;
    gap: 6px;

    .eval-gauge--horizontal {
      flex-shrink: 0;
    }

    .analyse__board {
      flex: 1;
    }
  }

  &__tools {
    grid-area: tools;
  }

  &__controls {
    grid-area: controls;
  }

  &__underboard {
    grid-area: under;

    @include mq-is-col1 {
      overflow: hidden; // helps truncating long study names
    }
  }

  &__round-training {
    grid-area: round-training;
  }

  &__puzzle {
    grid-area: puzzle;
  }

  .chat__members {
    grid-area: uchat;
  }

  .keyboard-move {
    display: none;
  }

  ---chat-height: fit-content(0);

  &--wiki {
    ---chat-height: 0;
  }

  .mchat {
    margin: $analyse-block-gap 0 0 0;
  }

  grid-template-rows: auto auto auto minmax(20em, 40vh);
  grid-template-areas: 'board'
  'controls'
  'kb-move'
  'tools'
  'side'
  'round-training'
  'under'
  'chat'
  'uchat';

  @include mq-at-least-col2 {
    // Chesstory: modern workspace layout with a vertical sidebar.
    ---board-scale: calc(((var(---zoom, 80) / 100) * 0.75 + 0.25) * 0.75);

    grid-template-columns: 50px min(var(---col2-uniboard-width), 560px) 24px 450px;
    grid-template-rows: auto auto auto auto $chat-height;
    grid-template-areas:
      'sidebar board        . tools'
      'sidebar controls     . tools'
      'sidebar under        . tools'
      'sidebar chat         . uchat';

    grid-row-gap: 24px;
    padding: 24px;

    &__sidebar {
      grid-area: sidebar;
      display: flex;
      flex-direction: column;
      background: $c-bg-low;
      border-right: 1px solid $c-border;
      height: 100%;

      .fbt {
        background: none;
        border: none;
        outline: none;
        align-items: normal;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: $c-font-dim;
        border-bottom: 1px solid $c-border;

        &:hover {
          color: $c-primary;
          background: rgba($c-primary, 0.05);
        }

        &.active {
          color: $c-primary;
          background: rgba($c-primary, 0.1);
          border-left: 3px solid $c-primary;
        }

        svg {
          width: 22px;
          height: 22px;
        }
      }
    }

    &__side,
    &__tools {
      min-width: 0;
      max-width: none;
    }

    &--bookmaker {
      grid-template-rows: auto auto auto auto minmax(22rem, 45vh) auto $chat-height;
      grid-template-areas:
        'sidebar board        . tools'
        'sidebar controls     . tools'
        'sidebar under        . tools'
        'sidebar side         side side'
        'sidebar chat         . uchat';
    }
  }

  @include mq-is-col2-squeeze {
    grid-template-columns: $col2-uniboard-squeeze-width $analyse-block-gap $col2-uniboard-squeeze-table;
  }

  @include mq-at-least-col3 {
    // Chesstory: keep wide screens stable and avoid "board suddenly grows" jump.
    ---board-scale: calc(((var(---zoom, 80) / 100) * 0.75 + 0.25) * 0.72);

    grid-template-columns: min(var(---col3-uniboard-width), 560px) $analyse-block-gap 450px;
    grid-template-rows: auto auto auto auto auto $chat-height;
    grid-template-areas:
      'board        . tools'
      'controls     . tools'
      'kb-move      . tools'
      'under        . tools'
      'round-training round-training round-training'
      'chat         . uchat';

    grid-row-gap: $analyse-block-gap;

    &__side,
    &__tools {
      min-width: 0;
      max-width: none;
    }

    &--bookmaker {
      grid-template-columns: min(var(---col3-uniboard-width), 560px) 24px 450px 24px minmax(360px, 1fr);
      grid-template-rows: auto auto auto auto auto $chat-height;
      grid-template-areas:
        'board        . tools . side'
        'controls     . tools . side'
        'kb-move      . tools . side'
        'under        . tools . side'
        'round-training round-training round-training round-training round-training'
        'chat         . uchat . .';
    }

    grid-row-gap: 24px;
    padding: 32px;

    .mchat {
      margin-top: 0;
      min-height: 10em;
    }

    @include crosstable-large;
  }
}

.blind-mode .analyse {
  display: block;
}